---
title: "Final ENM Script for S. tortuosus"
author: "Natalie Love"
date: "8/30/2020"
output: html_document
---

##Load packages
```{r, message=FALSE}
library(spThin)
library(dismo)
library(maptools)
library(rgdal)
library(raster)
library(sp)
library(ENMTools)
library(gtools)
library(rJava)
library(tidyverse)
library(sf)
library(gstat) #variogram
library(RStoolbox) #raster PCA
library(viridis)
library(ENMeval)
```

#1. Read in occurence data and remove spatial duplicates
These are from my herbarium dataset and lack duplicates (in time and space but not just space), those that do not have a exact DOY, those that have an error radius less than 4km, those that are in flower. These represent specimens that fall within the boundaries of the California Floristic Province (CFP). Of the 784 in the complete dataset, only six occurrences did not fall within the boundaries of the CFP. Those have already been removed.
```{r}
tort_occ <- read.csv(file = "data/occurrences/tort_occ_cfp.csv")
head(tort_occ)

#remove columns that are not spatial coordinates
tort_occ <- tort_occ[,1:2]
head(tort_occ)

#remove spatial duplicates, removes 44 occurences with exactly the same coordinates
tort_occ_unique <- unique.data.frame(tort_occ)
```

#2. Read in climate data (rasters)
Each climate variable is represented as a grid called a raster.
```{r}
#read in Rasters from current climate folder
list <- list.files(path = "data/current_climate/", full.names = TRUE, recursive = FALSE)

#sort list by the numeric values (ignore characters), these will be sorted 1-15, then solar radiation
list <- mixedsort(sort(list))
list

#create raster stack
predictors.cfp <- stack(list)

#names should have the names of all the predictors
predictors.cfp

#plot
plot(predictors.cfp[[1]]) #MAT
#plot occurrence points with raster
points(x = tort_occ$X, 
       y = tort_occ$Y, 
       col = "red", 
       pch = 20, 
       cex = 0.75)
```


#3. Thin occurrences
Need to thin occurences to reduce sampling bias. I used the package spThin, which requires a user inputted nearest neighbor distance. The package will randomly chose a point to thin in a pair of points within the nearest neighbor distance. Ideally, thinning occurences will reduce autocorrelation among occurrences in environmental space, but retain enough occurrences to build a robust model. To determine the optimum nearest neighbor distance, I constructed variograms using PC values for the environmental climate layers.

###3a. Create Raster PCA
Reduce dimensionality among environmental layers
```{r}
#Create raster PCA
cfp.pca <- rasterPCA(predictors.cfp, #raster stack
                     spca = TRUE, #preform standardized PCA, scaled and centered
                     maskCheck = TRUE) #masks NAs
#Save raster brick which is the map object
climate_pcs <- cfp.pca$map
plot(climate_pcs[[1]]) #plot PC1

#PCA Summary statistics
summary(cfp.pca$model)
loadings(cfp.pca$model)
```

###3b. Extract PC values for each occurrence
I need a dataframe that has the XY coordinates of each occurrence plus its PC value across all of the PC rasters. I used the extract function from the `raster` package. Need to indicate which columns are `[,longitude, latitude]` or X and Y.
```{r}
#Extract PC values
tort_climate_pca <- raster::extract(climate_pcs, tort_occ_unique[,c(1,2)])
head(tort_climate_pca)

#Need to bind back to columns with coordinates
tort_climate_pca_alldata <- cbind(tort_occ_unique, tort_climate_pca)
head(tort_climate_pca_alldata)
```

###3c. Create variogram to determine the distance at which points are no longer correlated
Uses functions in the `gstat` and `sp` packages
```{r}
#make data.frame into spatialpointsdataframe with package sp. Make a copy of dataframe with all the necessary info
tort_occ_climate.sp <-tort_climate_pca_alldata

#create sp object by defining which columns are the coodinates
coordinates(tort_occ_climate.sp) = ~X+Y
head(tort_occ_climate.sp) #coordinates are no longer a column but are defined as part of the object

#create variogram based on PCs
#I used PC1 and PC1 because, together, they account for 71% of the variance in climate
vario_tort_PC1 <- variogram(PC1~1, data = tort_occ_climate.sp, cutoff = 5)
vario_tort_PC2 <- variogram(PC2~1, data = tort_occ_climate.sp, cutoff = 5)

#plot
par(mfrow=c(1,2))
plot(vario_tort_PC1)
plot(vario_tort_PC2)
```

###3d. Fit a model to the points to determine the range
The range is the distance between points where they are no longer highly correlated. There are different models (different line functions). Here I chose the sphere option.

Need to give starting values for the sill, range, and nugget.

* Sill: Value where semivariance is no longer increasing
* Range: Distance between points where semivariance is no longer increasing
* Nugget: Where the curve crosses the y-axis
  
![](https://vsp.pnnl.gov/help/image/Variogram.gif)
```{r}
#fit models
vario_tort_PC1.fit <- fit.variogram(vario_tort_PC1, 
                                model = vgm(psill = 3, model = "Sph", range = 1, nugget = 0.5))

vario_tort_PC2.fit <- fit.variogram(vario_tort_PC2, model = vgm(psill = 0.6, model = "Sph", range = 3, nugget = 0.1))

#plot
par(mfrow = c(1,2))
plot(vario_tort_PC1,vario_tort_PC1.fit, main = "Variogram for PC1")
plot(vario_tort_PC2,vario_tort_PC2.fit, main = "Variogram for PC2")

#check output for range value
vario_tort_PC1.fit
vario_tort_PC2.fit
```

###3e. Use `spThin` to thin occurrences
Check out `?thin` for more information
```{r}
#need to have species name column for thin function to work
sp <- rep("Streptanthus_tortuosus", nrow(tort_occ_unique))
tort_occ_spThin <- cbind(sp,tort_occ_unique)
head(tort_occ_spThin)

tort_thin <- thin(loc.data = tort_occ_spThin,
     lat.col = "Y", #latitude column
     long.col = "X", #longitude column
     spec.col = "sp", #species name
     thin.par = 1.77, #nearest neighbor distance determined from variograms
     reps = 100, #how many times to do the random thinning process
     locs.thinned.list.return = TRUE, 
     write.files = TRUE, #write thinned files to CSV
     max.files = 10, #how many versions do you want
     out.dir = "data/occurrences/thinned/", #where do you want to put them
     out.base = "tort_thinned", #what shall we name them
     write.log.file = TRUE, #print a log of what was done for future reference
     log.file = "data/occurrences/thinned/tortuosus_thinned_full_log_file.txt") #whats that log going to be called and where shall I put it

#look at if we have enough reps to consistently get the maximum number of records retained
#max is 549 occurrences
plotThin(tort_thin)
```

###3f. Read in thinned occurrence file
```{r}
tort_occ_thinned <- read_csv("data/occurrences/tort_thinned.csv")

#plot thinned and unthinned occurrences together
plot(predictors.cfp[[1]]) #MAT
#plot occurrence points with raster
points(x=tort_occ$X,
       y=tort_occ$Y,
       col="gray",
       pch = 20,
       cex = 0.75)
points(x = tort_occ_thinned$X, 
       y = tort_occ_thinned$Y, 
       col = "red", 
       pch = 1, 
       cex = 0.75)
```

#4. Get occurrence data ready and generate background points
Generate background points to characterize the environment (CFP)
```{r}
#just need the lat and long
tort_occ <- tort_occ_thinned[,2:3]
head(tort_occ)

#generate random background points
set.seed(42)
backg <- randomPoints(predictors.cfp, #raster stack
                      n = 10000) 

#Map presence and background points
plot(predictors.cfp[[1]])
points(backg, pch = "-", col = "red")
points(tort_occ, pch = "+", col = "blue")
```


#5. Construct MaxEnt Model
This code needs to communicate with the MaxEnt Java file. the maxent.jar needs to go in a specific folder within the package Dismo
```{r}
#find out where to put .jar
system.file("java", package="dismo")

#define location of jar file
jar <- "/Library/Frameworks/R.framework/Versions/4.0/Resources/library/dismo/java/maxent.jar"

#run Maxent model
xm <- maxent(x = predictors.cfp, 
               p = as.matrix(tort_occ), #occurrences
               a = as.matrix(backg), #background points 
               path = "data/output/083120"
               )
plot(xm)
response(xm)
```

#6. Evaluate Model using k-fold validation
The thinned presence points will be divided into 5 groups. The presence testing data will be 80% of the data. The other 20% will be used for testing. This will be done iteratively through five folds.
```{r}
#create groups, we are going do to 5 "folds"
k <- 5

#designate folds for presence data
group_p <- kfold(tort_occ, k) #creates a vector that assigns each row in the matrix to a group between 1 and k
group_p[1:10] #take a look at the vector
unique(group_p) #should return 1 2 3 4 5

#designate folds for background data
group_b <- kfold(backg, k)
group_b[1:10]


#for loop to do all five folds iteratively 
e <- list() #create empty list to fill with for-loop
for (i in 1:5) {
  train_p <- tort_occ[group_p !=i,] #training dataset with 4 groups that are not in group i (1-5)
  test_p <- tort_occ[group_p == i,]#test dataset is all presences in group i
  train_b <- backg[group_b !=i,] #training dataset for background not in group i
  test_b <- backg[group_b == i,]
  #construct maxent model using training data
  mx_e <- maxent(x = predictors.cfp,
                 p = as.matrix(train_p), 
                 a = as.matrix(train_b),
                 path = paste("data/output/083120_noreps/",i, sep = "")) 
  #evaluate using testing data
  e[[i]] <- evaluate(p = as.matrix(test_p), 
                     a = as.matrix(test_b),
                     model = mx_e,
                     x = predictors.cfp) #evaluate with test and training, always using all backgroud points and add to list
}

e

#extract AUC and max TSS
auc <- sapply(e, function(x){slot(x, "auc")})
auc
mean(auc)
sd(auc)

#get max tss
maxTSS <- sapply(e, function(x){ x@t[which.max(x@TPR + x@TNR)] } )
maxTSS
mean(maxTSS)
sd(maxTSS)
```

#6b. Plot test/train
This will plot test and train points for the last iteration.
train_b = `nrow(train_p)` points
test_b = `nrow(test_b)` points
train_p = `nrow(train_p)` points
test_p = `nrow(test_p)` points
```{r}
#plot test vs. training datasets
plot(predictors.cfp[[1]])
points(train_b, pch = "-", col = "red", cex = 0.5)
points(test_b, pch = "-", col = "black", cex = 0.5)
points(train_p, pch = "+", col = "blue", cex = 0.5)
points(test_p, pch = "+", col = "green", cex = 0.5)
```

#7. Use Maxent Model to create current suitability map (make predictions across climate layers)
This will take the model (xm) and use it to predict the probability that the species will occur at any given grid cell in the CFP. Predict outputs a raster layer with values that range from 0-1.
```{r}
px <- dismo::predict(predictors.cfp, xm)
plot(px)

writeRaster(px, "data/output/suitability_rasters/current_suitability.tif", format = "GTiff")

```
###7a. Create map in ggplot
To plot rasters in ggplot, I need to make the raster object into a dataframe
```{r}
#turn raster into dataframe
px_df <- as.data.frame(px, xy = TRUE)
head(px_df) #layer has the suitability scores

#create sf object with occurences for easy plotting with ggplot
tort_occ_sf <- st_as_sf(tort_occ, coords = c("X","Y"), crs = 4326)
class(tort_occ_sf)

#plot with ggplot with occurrence points
px_gg <- ggplot() +
  geom_raster(data = px_df, aes(x = x, y = y, fill = layer)) +
  scale_fill_viridis(limits = c(0,1), na.value = "transparent") + #viridis color 
  geom_sf(data = tort_occ_sf, size = 1, color = "white") + #plot occurrence points
  coord_sf() + #need to tell ggplot these are spatial data
  xlab("Longitude") +
  ylab("Latitude") +
  labs(fill = "Suitability") +
  theme_bw(base_size = 14)

px_gg

#no occurrence points
px_gg <- ggplot() +
  geom_raster(data = px_df, aes(x = x, y = y, fill = layer)) +
  scale_fill_viridis(limits = c(0,1), na.value = "transparent") + #viridis color 
  coord_sf() + #need to tell ggplot these are spatial data
  xlab("Longitude") +
  ylab("Latitude") +
  labs(fill = "Suitability") +
  theme_bw(base_size = 14)

px_gg 
```

#8. Create binary presence/absence rasters for current climate
Presence/absense at a given grid cell depends on a given suitability threshold. The "spec_sens" option is the suitability threshold that gives the maximum true positive rate (TPR) and True negative rate (TNR) 
```{r}
tr <- mean(maxTSS)
tr

#plot
plot(px > tr, main = "presence/absence")
#add training points
points(train_p, pch="+", cex = 0.5)

#make a copy of px
binary_px <- px

#replace values in raster that are less than the threshold with 0
binary_px[binary_px < tr] <- 0

#replace value sin the raster that are greater than or equal to the threshold with 1
binary_px[binary_px >= tr] <-1

#plot
plot(binary_px)

writeRaster(binary_px, "data/output/binary_rasters/binary_current.tif", format = "GTiff")

```

###8a. Plot binary maps with ggplot
```{r}
#make raster a df
binary_px_df <- as.data.frame(binary_px, xy = TRUE)
head(binary_px_df)

#plot with ggplot
binary_px_df_gg <- ggplot() +
  geom_raster(data = binary_px_df, aes(x = x, y = y, fill = as.factor(layer))) +
  scale_fill_viridis(na.value = "transparent", discrete = TRUE, name = "Presence/Absence", labels = c("Absence","Presence","")) +
  coord_sf() +
  xlab("Longitude") +
  ylab("Latitude") +
  theme_bw(base_size = 14)

binary_px_df_gg
```

#9. Using model to make temporal projections (on novel climates)
I am going to project this model onto a total of 5 future climate models in two time periods and two emission pathways

**Near Future: 2021-2040**
SSP 245
SSP 585

**Distant Future: 2080-2100**
SSP 245
SSP 585

**Future Models (5 total)**
BCC-CSM2 (BCC)
CNRM-CM6-1
CNRM-ESM2 (CNRM)
CanESM5
MIROC 6

###9a. Read in future climate data
Unhash list to see the relative path names and double check they are correct
###9a. Near Future: 2021-2040 - SSP 245
```{r}
###BCC 245 2021-2040
list <- list.files(path = "data/future_climate/BCC_245_2021", full.names = TRUE, recursive = FALSE)
list <- mixedsort(sort(list))
#list
BCC_245_2021_stack <- stack(list)
#names should match
names(BCC_245_2021_stack)
names(predictors.cfp)

##CanESM5-CM6
list <- list.files(path = "data/future_climate/CanESM5_245_2021", full.names = TRUE, recursive = FALSE)
list <- mixedsort(sort(list))
#list
CanESM5_245_2021_stack <- stack(list)
names(CanESM5_245_2021_stack) <- c("bio01","bio02","bio04","bio05","bio12","bio15","bio18","srad_ann")
#names should match
names(CanESM5_245_2021_stack)
names(predictors.cfp)

##CNRM CM6
list <- list.files(path = "data/future_climate/CNRM_CM6_1_245_2021", full.names = TRUE, recursive = FALSE)
list <- mixedsort(sort(list))
list
CNRM_CM6_1_245_2021_stack <- stack(list)
names(CNRM_CM6_1_245_2021_stack) <- c("bio01","bio02","bio04","bio05","bio12","bio15","bio18","srad_ann")
#names should match
names(CNRM_CM6_1_245_2021_stack)
names(predictors.cfp)

##CNRM ESM2 245 2021-2040
list <- list.files(path = "data/future_climate/CNRM_ESM2_245_2021", full.names = TRUE, recursive = FALSE)
list <- mixedsort(sort(list))
#list
CNRM_ESM2_245_2021_stack <- stack(list)
names(CNRM_ESM2_245_2021_stack) <- c("bio01","bio02","bio04","bio05","bio12","bio15","bio18","srad_ann")
#names should match
names(CNRM_ESM2_245_2021_stack)
names(predictors.cfp)

##MIROC6 245 2021-2040
list <- list.files(path = "data/future_climate/MIROC6_245_2021", full.names = TRUE, recursive = FALSE)
list <- mixedsort(sort(list))
#list
MIROC6_245_2021_stack <- stack(list)
names(MIROC6_245_2021_stack) <- c("bio01","bio02","bio04","bio05","bio12","bio15","bio18","srad_ann")
#names should match
names(MIROC6_245_2021_stack)
names(predictors.cfp)
```

### 9b. Near future 2021-2040, SSP 585
```{r}
###BCC 585 2021-2040
list <- list.files(path = "data/future_climate/BCC_585_2021", full.names = TRUE, recursive = FALSE)
list <- mixedsort(sort(list))
list
BCC_585_2021_stack <- stack(list)
#names should match
names(BCC_585_2021_stack)
names(predictors.cfp)

##CanESM5-CM6 585 2021-2040
list <- list.files(path = "data/future_climate/CanESM5_585_2021", full.names = TRUE, recursive = FALSE)
list <- mixedsort(sort(list))
list
CanESM5_585_2021_stack <- stack(list)
names(CanESM5_585_2021_stack) <- c("bio01","bio02","bio04","bio05","bio12","bio15","bio18","srad_ann")
#names should match
names(CanESM5_585_2021_stack)
names(predictors.cfp)

##CNRM CM6 585 2021-2040
list <- list.files(path = "data/future_climate/CNRM_CM6_1_585_2021", full.names = TRUE, recursive = FALSE)
list <- mixedsort(sort(list))
list
CNRM_CM6_1_585_2021_stack <- stack(list)
names(CNRM_CM6_1_585_2021_stack) <- c("bio01","bio02","bio04","bio05","bio12","bio15","bio18","srad_ann")
#names should match
names(CNRM_CM6_1_245_2021_stack)
names(predictors.cfp)

##CNRM ESM2 585 2021-2040
list <- list.files(path = "data/future_climate/CNRM_ESM2_585_2021", full.names = TRUE, recursive = FALSE)
list <- mixedsort(sort(list))
list
CNRM_ESM2_585_2021_stack <- stack(list)
names(CNRM_ESM2_585_2021_stack) <- c("bio01","bio02","bio04","bio05","bio12","bio15","bio18","srad_ann")
#names should match
names(CNRM_ESM2_585_2021_stack)
names(predictors.cfp)

##MIROC6 585 2021-2040
list <- list.files(path = "data/future_climate/MIROC6_585_2021", full.names = TRUE, recursive = FALSE)
list <- mixedsort(sort(list))
list
MIROC6_585_2021_stack <- stack(list)
names(MIROC6_585_2021_stack) <- c("bio01","bio02","bio04","bio05","bio12","bio15","bio18","srad_ann")
#names should match
names(MIROC6_585_2021_stack)
names(predictors.cfp)

```

###9c. Distant Future (2081-2100): SSP 245
```{r}
###BCC 245 2081-2100
list <- list.files(path = "data/future_climate/BCC_245_2081", full.names = TRUE, recursive = FALSE)
list <- mixedsort(sort(list))
list
BCC_245_2081_stack <- stack(list)
#names should match
names(BCC_245_2081_stack)
names(predictors.cfp)

##CanESM5-CM6 2081-2100 SSP 245
list <- list.files(path = "data/future_climate/CanESM5_245_2081", full.names = TRUE, recursive = FALSE)
list <- mixedsort(sort(list))
list
CanESM5_245_2081_stack <- stack(list)
names(CanESM5_245_2081_stack) <- c("bio01","bio02","bio04","bio05","bio12","bio15","bio18","srad_ann")
#names should match
names(CanESM5_245_2081_stack)
names(predictors.cfp)

##CNRM CM6 2081-2100 SSP 245
list <- list.files(path = "data/future_climate/CNRM_CM6_1_245_2081", full.names = TRUE, recursive = FALSE)
list <- mixedsort(sort(list))
list
CNRM_CM6_1_245_2081_stack <- stack(list)
names(CNRM_CM6_1_245_2081_stack) <- c("bio01","bio02","bio04","bio05","bio12","bio15","bio18","srad_ann")
#names should match
names(CNRM_CM6_1_245_2081_stack)
names(predictors.cfp)

##CNRM ESM2 245 2081-2100
list <- list.files(path = "data/future_climate/CNRM_ESM2_245_2081", full.names = TRUE, recursive = FALSE)
list <- mixedsort(sort(list))
list
CNRM_ESM2_245_2081_stack <- stack(list)
names(CNRM_ESM2_245_2081_stack) <- c("bio01","bio02","bio04","bio05","bio12","bio15","bio18","srad_ann")
#names should match
names(CNRM_ESM2_245_2081_stack)
names(predictors.cfp)

##MIROC6 245 2081-2100
list <- list.files(path = "data/future_climate/MIROC6_245_2081", full.names = TRUE, recursive = FALSE)
list <- mixedsort(sort(list))
list
MIROC6_245_2081_stack <- stack(list)
names(MIROC6_245_2081_stack) <- c("bio01","bio02","bio04","bio05","bio12","bio15","bio18","srad_ann")
#names should match
names(MIROC6_245_2081_stack)
names(predictors.cfp)
```

###9d. Distant future (2081-2100) SSP 585
```{r}
###BCC 585 2021-2040
list <- list.files(path = "data/future_climate/BCC_585_2081", full.names = TRUE, recursive = FALSE)
list <- mixedsort(sort(list))
list
BCC_585_2081_stack <- stack(list)
#names should match
names(BCC_585_2081_stack)
names(predictors.cfp)

##CanESM5-CM6 585 2081-2100
list <- list.files(path = "data/future_climate/CanESM5_585_2081", full.names = TRUE, recursive = FALSE)
list <- mixedsort(sort(list))
list
CanESM5_585_2081_stack <- stack(list)
names(CanESM5_585_2081_stack) <- c("bio01","bio02","bio04","bio05","bio12","bio15","bio18","srad_ann")
#names should match
names(CanESM5_585_2081_stack)
names(predictors.cfp)

##CNRM CM6 585 2081-2100
list <- list.files(path = "data/future_climate/CNRM_CM6_1_585_2081", full.names = TRUE, recursive = FALSE)
list <- mixedsort(sort(list))
list
CNRM_CM6_1_585_2081_stack <- stack(list)
names(CNRM_CM6_1_585_2081_stack) <- c("bio01","bio02","bio04","bio05","bio12","bio15","bio18","srad_ann")
#names should match
names(CNRM_CM6_1_245_2081_stack)
names(predictors.cfp)

##CNRM ESM2 585 2081-2100
list <- list.files(path = "data/future_climate/CNRM_ESM2_585_2081", full.names = TRUE, recursive = FALSE)
list <- mixedsort(sort(list))
list
CNRM_ESM2_585_2081_stack <- stack(list)
names(CNRM_ESM2_585_2081_stack) <- c("bio01","bio02","bio04","bio05","bio12","bio15","bio18","srad_ann")
#names should match
names(CNRM_ESM2_585_2081_stack)
names(predictors.cfp)

##MIROC6 585 2081-2100
list <- list.files(path = "data/future_climate/MIROC6_585_2081", full.names = TRUE, recursive = FALSE)
list <- mixedsort(sort(list))
list
MIROC6_585_2081_stack <- stack(list)
names(MIROC6_585_2081_stack) <- c("bio01","bio02","bio04","bio05","bio12","bio15","bio18","srad_ann")
#names should match
names(MIROC6_585_2081_stack)
names(predictors.cfp)
```


###9e. Use Maxent model to project onto future raster climate stacks - Near future (2021-2040) - SSP 245 
```{r}
#BCC 245 2021-2040
px_BCC2452021 <- predict(object = xm,
                         x = BCC_245_2021_stack,
                         filename = "data/output/suitability_rasters/245_2021/px_BCC2452021",
                         progress = "text",
                         args = c("doclamp=TRUE"))

plot(px_BCC2452021)

#Can ESM5 245 2021-2040
px_CanESM52452021 <- predict(object = xm,
                         x = CanESM5_245_2021_stack,
                         filename = "data/output/suitability_rasters/245_2021/px_CanESM52452021",
                         progress = "text",
                         args = c("doclamp=TRUE"))

plot(px_CanESM52452021)

#CNRM_CM6_1 245 2021-2040
px_CNRMCM61_2452021 <- predict(object = xm,
                         x = CNRM_CM6_1_245_2021_stack,
                         filename = "data/output/suitability_rasters/245_2021/px_CNRMCM61_2452021",
                         progress = "text",
                         args = c("doclamp=TRUE"))

plot(px_CNRMCM61_2452021)

#CNRM_ESM2 245 2021-2040
px_CNRMESM2_2452021 <- predict(object = xm,
                         x = CNRM_ESM2_245_2021_stack,
                         filename = "data/output/suitability_rasters/245_2021/px_CNRMESM2_2452021",
                         progress = "text",
                         args = c("doclamp=TRUE"))

plot(px_CNRMESM2_2452021)

#MIROC6 245 2021-2040
px_MIROC6_2452021 <- predict(object = xm,
                         x = MIROC6_245_2021_stack,
                         filename = "data/output/suitability_rasters/245_2021/px_MIROC6_2452021",
                         progress = "text",
                         args = c("doclamp=TRUE"))

plot(px_MIROC6_2452021)
```

###9f. Use Maxent model to project onto future raster climate stacks - Distant Future (2081-2040) - SSP 245 
```{r}
#BCC 245 2081-2100
px_BCC2452081 <- predict(object = xm,
                         x = BCC_245_2081_stack,
                         filename = "data/output/suitability_rasters/245_2081/px_BCC2452081",
                         progress = "text",
                         args = c("doclamp=TRUE"))

plot(px_BCC2452081)

#Can ESM5 245 2081-2100
px_CanESM52452081 <- predict(object = xm,
                         x = CanESM5_245_2081_stack,
                         filename = "data/output/suitability_rasters/245_2081/px_CanESM52452081",
                         progress = "text",
                         args = c("doclamp=TRUE"))

plot(px_CanESM52452081)

#CNRM_CM6_1 245 2081-2100
px_CNRMCM61_2452081 <- predict(object = xm,
                         x = CNRM_CM6_1_245_2081_stack,
                         filename = "data/output/suitability_rasters/245_2081/px_CNRMCM61_2452081",
                         progress = "text",
                         args = c("doclamp=TRUE"))

plot(px_CNRMCM61_2452081)

#CNRM_ESM2 245 2081-2100
px_CNRMESM2_2452081 <- predict(object = xm,
                         x = CNRM_ESM2_245_2081_stack,
                         filename = "data/output/suitability_rasters/245_2081/px_CNRMESM2_2452081",
                         progress = "text",
                         args = c("doclamp=TRUE"))

plot(px_CNRMESM2_2452081)

#MIROC6 245 2081-2040
px_MIROC6_2452081 <- predict(object = xm,
                         x = MIROC6_245_2081_stack,
                         filename = "data/output/suitability_rasters/245_2081/px_MIROC6_2452081",
                         progress = "text",
                         args = c("doclamp=TRUE"))

plot(px_MIROC6_2452081)
```
##9g. Use Maxent model to project onto future raster climate stacks - Near Future (2021-2040) - SSP 585 
```{r}
#BCC 585 2021-2040
px_BCC5852021 <- predict(object = xm,
                         x = BCC_585_2021_stack,
                         filename = "data/output/suitability_rasters/585_2021/px_BCC5852021",
                         progress = "text",
                         args = c("doclamp=TRUE"))

plot(px_BCC5852021)

#Can ESM5 585 2021-2040
px_CanESM55852021 <- predict(object = xm,
                         x = CanESM5_585_2021_stack,
                         filename = "data/output/suitability_rasters/585_2021/px_CanESM55852021",
                         progress = "text",
                         args = c("doclamp=TRUE"))

plot(px_CanESM55852021)

#CNRM_CM6_1 585 2021-2040
px_CNRMCM61_5852021 <- predict(object = xm,
                         x = CNRM_CM6_1_585_2021_stack,
                         filename = "data/output/suitability_rasters/585_2021/px_CNRMCM61_5852021",
                         progress = "text",
                         args = c("doclamp=TRUE"))

plot(px_CNRMCM61_5852021)

#CNRM_ESM2 585 2021-2040
px_CNRMESM2_5852021 <- predict(object = xm,
                         x = CNRM_ESM2_585_2021_stack,
                         filename = "data/output/suitability_rasters/585_2021/px_CNRMESM2_5852021",
                         progress = "text",
                         args = c("doclamp=TRUE"))

plot(px_CNRMESM2_5852021)

#MIROC6 585 2021-2040
px_MIROC6_5852021 <- predict(object = xm,
                         x = MIROC6_585_2021_stack,
                         filename = "data/output/suitability_rasters/585_2021/px_MIROC6_5852021",
                         progress = "text",
                         args = c("doclamp=TRUE"))

plot(px_MIROC6_5852021)
```

###9h. Use Maxent model to project onto future raster climate stacks - Distant Future (2081-2100) - SSP 585
```{r}
#BCC 585 2081-2100
px_BCC5852081 <- predict(object = xm,
                         x = BCC_585_2081_stack,
                         filename = "data/output/suitability_rasters/585_2081/px_BCC5852081",
                         progress = "text",
                         args = c("doclamp=TRUE"))

plot(px_BCC5852081)

#Can ESM5 585 2081-2100
px_CanESM55852081 <- predict(object = xm,
                         x = CanESM5_585_2081_stack,
                         filename = "data/output/suitability_rasters/585_2081/px_CanESM55852081",
                         progress = "text",
                         args = c("doclamp=TRUE"))

plot(px_CanESM55852081)

#CNRM_CM6_1 585 2081-2100
px_CNRMCM61_5852081 <- predict(object = xm,
                         x = CNRM_CM6_1_585_2081_stack,
                         filename = "data/output/suitability_rasters/585_2081/px_CNRMCM61_5852081",
                         progress = "text",
                         args = c("doclamp=TRUE"))

plot(px_CNRMCM61_5852081)

#CNRM_ESM2 585 2081-2100
px_CNRMESM2_5852081 <- predict(object = xm,
                         x = CNRM_ESM2_585_2081_stack,
                         filename = "data/output/suitability_rasters/585_2081/px_CNRMESM2_5852081",
                         progress = "text",
                         args = c("doclamp=TRUE"))

plot(px_CNRMESM2_5852081)

#MIROC6 585 2081-2100
px_MIROC6_5852081 <- predict(object = xm,
                         x = MIROC6_585_2081_stack,
                         filename = "data/output/suitability_rasters/585_2081/px_MIROC6_5852081",
                         progress = "text",
                         args = c("doclamp=TRUE"))

plot(px_MIROC6_5852081)
```


###9d.Make model prediction averages for each scenario
```{r}
####245 Near Future (2021-2080)
#Read in future climate suitability raster and create raster stack
list <- list.files(path = "data/output/suitability_rasters/245_2021", pattern = "\\.grd$", full.names = TRUE)
sort.list(list)
list #check that its right
future_rasters_245_2021 <- stack(list)

#set names for layers
list <- list.files(path = "data/output/suitability_rasters/245_2021", pattern = "\\.grd$") #doesnt need full name
sort.list(list)
list
names(future_rasters_245_2021) <- c(list)
names(future_rasters_245_2021) #now has names for each layer

#calculate mean
mean_future_245_2021 <- calc(future_rasters_245_2021, fun = mean)
plot(mean_future_245_2021)

#####245 Distant Future (2081-2100)
#Read in future climate suitability raster and create raster stack
list <- list.files(path = "data/output/suitability_rasters/245_2081", pattern = "\\.grd$", full.names = TRUE)
sort.list(list)
list #check that its right
future_rasters_245_2081 <- stack(list)

#set names for layers
list <- list.files(path = "data/output/suitability_rasters/245_2081", pattern = "\\.grd$") #doesnt need full name
sort.list(list)
list
names(future_rasters_245_2081) <- c(list)
names(future_rasters_245_2081) #now has names for each layer

#calculate mean
mean_future_245_2081 <- calc(future_rasters_245_2081, fun = mean)
plot(mean_future_245_2081)


```

###9XX. Create binary maps
```{r}
#make a copy for binary rasters
binary_future_rasters <- future_rasters
#make layers binary based on MaxTSS threshold
binary_future_rasters[binary_future_rasters < tr] <- 0
binary_future_rasters[binary_future_rasters > tr] <- 1
plot(binary_future_rasters)

#writeRaster(binary_future_rasters, "data/output/binary_rasters/binary", format = "GTiff", bylayer = TRUE, suffix = "names")
```


###9XX. Create rasters that represent expansion/loss/no change in habitat
Projected-Current = scenario
2 - 0 = 2 (expansion or gain)
0 - 1 = -1 (loss)
2 - 1 = 1 (no change in range, remains constant)
0 - 0 = 0 (was never there), plots as -2 (see below)
Need to change 0 to -2 so it will plot as the lowest value for ggplot
```{r}
#replace 1s with 2s so we get unique valies for scenarios listed above
binary_future_rasters[binary_future_rasters == 1] <-2

#calculate difference to get one of the four values listed above in the raster stack
binary_future_rasters_rangediff <- binary_future_rasters - binary_px
binary_future_rasters_rangediff

#replace names again, they were changed after math
names(binary_future_rasters_rangediff) <- list
plot(binary_future_rasters_rangediff)

#the "was never there" scenario needs to be plotted last in ggplot so I replaced 0 with -2s
binary_future_rasters_rangediff[binary_future_rasters_rangediff == 0] <- -2

```

###9f. Convert rasters (binary and suitability) into dataframes for plotting with ggplot
Use for loop to iteratively turn each layer in the raster stack into a dataframe with xy coordinates
```{r}
###Suitability
#BCC
suitability_BCC2452021_df <- as.data.frame(future_rasters[[1]], xy = TRUE)
head(suitability_BCC2452021_df)
suitability_BCC2452081_df <- as.data.frame(future_rasters[[2]], xy = TRUE)
head(suitability_BCC2452081_df)
suitability_BCC5852021_df <- as.data.frame(future_rasters[[3]], xy = TRUE)
head(suitability_BCC5852021_df)
suitability_BCC5852081_df <- as.data.frame(future_rasters[[4]], xy = TRUE)
head(suitability_BCC5852081_df)

#CNRM
suitability_CNRM2452021_df <- as.data.frame(future_rasters[[5]], xy = TRUE)
head(suitability_CNRM2452021_df)
suitability_CNRM2452081_df <- as.data.frame(future_rasters[[6]], xy = TRUE)
head(suitability_CNRM2452081_df)
suitability_CNRM5852021_df <- as.data.frame(future_rasters[[7]], xy = TRUE)
head(suitability_CNRM5852021_df)
suitability_CNRM5852081_df <- as.data.frame(future_rasters[[8]], xy = TRUE)
head(suitability_CNRM5852081_df)

###Binary
#BCC
binary_diff_BCC2452021_df <- as.data.frame(binary_future_rasters_rangediff[[1]], xy = TRUE)
head(binary_diff_BCC2452021_df)
binary_diff_BCC2452081_df <- as.data.frame(binary_future_rasters_rangediff[[2]], xy = TRUE)
head(binary_diff_BCC2452081_df)
binary_diff_BCC5852021_df <- as.data.frame(binary_future_rasters_rangediff[[3]], xy = TRUE)
head(binary_diff_BCC5852021_df)
binary_diff_BCC5852081_df <- as.data.frame(binary_future_rasters_rangediff[[4]], xy = TRUE)
head(binary_diff_BCC5852081_df)

#CNRM
binary_diff_CNRM2452021_df <- as.data.frame(binary_future_rasters_rangediff[[5]], xy = TRUE)
head(binary_diff_CNRM2452021_df)
binary_diff_CNRM2452081_df <- as.data.frame(binary_future_rasters_rangediff[[6]], xy = TRUE)
head(binary_diff_CNRM2452081_df)
binary_diff_CNRM5852021_df <- as.data.frame(binary_future_rasters_rangediff[[7]], xy = TRUE)
head(binary_diff_CNRM5852021_df)
binary_diff_CNRM5852081_df <- as.data.frame(binary_future_rasters_rangediff[[8]], xy = TRUE)
head(binary_diff_CNRM5852081_df)


#Suitability - not sure why this is not working?? Need the colon!
#for (i in i:8) {
  #suitability <- as.data.frame(future_rasters[[i]], xy = TRUE)
  #nam <- paste("suitability_", names(future_rasters[[i]]), "_df", sep = "")
  #assign(nam, suitability)
#}

```

###9. Plot Suitability rasters with ggplot
```{r}
suitability_BCC2452021_gg <- ggplot() +
  geom_raster(data = suitability_BCC2452021_df, aes(x = x, y = y, fill = BCC_245_2021.grd)) +
  scale_fill_viridis(limits = c(0,1), na.value = "transparent") + #viridis color 
  coord_sf() + #need to tell ggplot these are spatial data
  xlab("Longitude") +
  ylab("Latitude") +
  labs(fill = "Suitability") +
  theme_bw(base_size = 14)

suitability_BCC2452021_gg 

suitability_BCC2452081_gg <- ggplot() +
  geom_raster(data = suitability_BCC2452081_df, aes(x = x, y = y, fill = BCC_245_2081.grd)) +
  scale_fill_viridis(limits = c(0,1), na.value = "transparent") + #viridis color 
  coord_sf() + #need to tell ggplot these are spatial data
  xlab("Longitude") +
  ylab("Latitude") +
  labs(fill = "Suitability") +
  theme_bw(base_size = 14)

suitability_BCC2452081_gg 

suitability_BCC5852021_gg <- ggplot() +
  geom_raster(data = suitability_BCC5852021_df, aes(x = x, y = y, fill = BCC_585_2021.grd)) +
  scale_fill_viridis(limits = c(0,1), na.value = "transparent") + #viridis color 
  coord_sf() + #need to tell ggplot these are spatial data
  xlab("Longitude") +
  ylab("Latitude") +
  labs(fill = "Suitability") +
  theme_bw(base_size = 14)

suitability_BCC5852021_gg 

suitability_BCC5852081_gg <- ggplot() +
  geom_raster(data = suitability_BCC5852081_df, aes(x = x, y = y, fill = BCC_585_2081.grd)) +
  scale_fill_viridis(limits = c(0,1), na.value = "transparent") + #viridis color 
  coord_sf() + #need to tell ggplot these are spatial data
  xlab("Longitude") +
  ylab("Latitude") +
  labs(fill = "Suitability") +
  theme_bw(base_size = 14)

suitability_BCC5852081_gg

suitability_CNRM2452021_gg <- ggplot() +
  geom_raster(data = suitability_CNRM2452021_df, aes(x = x, y = y, fill = CNRM_245_2021.grd)) +
  scale_fill_viridis(limits = c(0,1), na.value = "transparent") + #viridis color 
  coord_sf() + #need to tell ggplot these are spatial data
  xlab("Longitude") +
  ylab("Latitude") +
  labs(fill = "Suitability") +
  theme_bw(base_size = 14)

suitability_CNRM2452021_gg

suitability_CNRM2452081_gg <- ggplot() +
  geom_raster(data = suitability_CNRM2452081_df, aes(x = x, y = y, fill = CNRM_245_2081.grd)) +
  scale_fill_viridis(limits = c(0,1), na.value = "transparent") + #viridis color 
  coord_sf() + #need to tell ggplot these are spatial data
  xlab("Longitude") +
  ylab("Latitude") +
  labs(fill = "Suitability") +
  theme_bw(base_size = 14)

suitability_CNRM2452081_gg

suitability_CNRM5852021_gg <- ggplot() +
  geom_raster(data = suitability_CNRM5852021_df, aes(x = x, y = y, fill = CNRM_585_2021.grd)) +
  scale_fill_viridis(limits = c(0,1), na.value = "transparent") + #viridis color 
  coord_sf() + #need to tell ggplot these are spatial data
  xlab("Longitude") +
  ylab("Latitude") +
  labs(fill = "Suitability") +
  theme_bw(base_size = 14)

suitability_CNRM5852021_gg

suitability_CNRM5852081_gg <- ggplot() +
  geom_raster(data = suitability_CNRM5852081_df, aes(x = x, y = y, fill = CNRM_585_2081.grd)) +
  scale_fill_viridis(limits = c(0,1), na.value = "transparent") + #viridis color 
  coord_sf() + #need to tell ggplot these are spatial data
  xlab("Longitude") +
  ylab("Latitude") +
  labs(fill = "Suitability") +
  theme_bw(base_size = 14)

suitability_CNRM5852081_gg

```

###9h. Make binary maps in ggplot
```{r}
binary_diff_BCC2452021_gg <- ggplot() +
  geom_raster(data = binary_diff_BCC2452021_df, aes(x = x, y = y, fill = as.factor(BCC_245_2021.grd))) +
  scale_fill_manual(name = "Range Change", values=c("gray","#440154FF","#29AF7FFF","#FDE725FF","transparent"), labels = c("California Floristic Province","Loss","No Change","Gain",""), guide = guide_legend(reverse = TRUE)) +
  coord_sf() +
  xlab("Longitude") +
  ylab("Latitude") +
  theme_bw(base_size = 14)

binary_diff_BCC2452021_gg

binary_diff_BCC2452081_gg <- ggplot() +
  geom_raster(data = binary_diff_BCC2452081_df, aes(x = x, y = y, fill = as.factor(BCC_245_2081.grd))) +
  scale_fill_manual(name = "Range Change", values=c("gray","#440154FF","#29AF7FFF","#FDE725FF","transparent"), labels = c("California Floristic Province","Loss","No Change","Gain",""), guide = guide_legend(reverse = TRUE)) +
  coord_sf() +
  xlab("Longitude") +
  ylab("Latitude") +
  theme_bw(base_size = 14)

binary_diff_BCC2452081_gg

binary_diff_BCC5852021_gg <- ggplot() +
  geom_raster(data = binary_diff_BCC5852021_df, aes(x = x, y = y, fill = as.factor(BCC_585_2021.grd))) +
  scale_fill_manual(name = "Range Change", values=c("gray","#440154FF","#29AF7FFF","#FDE725FF","transparent"), labels = c("California Floristic Province","Loss","No Change","Gain",""), guide = guide_legend(reverse = TRUE)) +
  coord_sf() +
  xlab("Longitude") +
  ylab("Latitude") +
  theme_bw(base_size = 14)

binary_diff_BCC5852021_gg

binary_diff_BCC5852081_gg <- ggplot() +
  geom_raster(data = binary_diff_BCC5852081_df, aes(x = x, y = y, fill = as.factor(BCC_585_2081.grd))) +
  scale_fill_manual(name = "Range Change", values=c("gray","#440154FF","#29AF7FFF","transparent"), labels = c("California Floristic Province","Loss","No Change",""), guide = guide_legend(reverse = TRUE)) +
  coord_sf() +
  xlab("Longitude") +
  ylab("Latitude") +
  theme_bw(base_size = 14)

binary_diff_BCC5852081_gg

##CNRM###
binary_diff_CNRM2452021_gg <- ggplot() +
  geom_raster(data = binary_diff_CNRM2452021_df, aes(x = x, y = y, fill = as.factor(CNRM_245_2021.grd))) +
  scale_fill_manual(name = "Range Change", values=c("gray88","#440154FF","#29AF7FFF","#FDE725FF","transparent"), labels = c("California Floristic Province","Loss","No Change","Gain",""), guide = guide_legend(reverse = TRUE)) +
  coord_sf() +
  xlab("Longitude") +
  ylab("Latitude") +
  theme_bw(base_size = 14)

binary_diff_CNRM2452021_gg

binary_diff_CNRM2452081_gg <- ggplot() +
  geom_raster(data = binary_diff_CNRM2452081_df, aes(x = x, y = y, fill = as.factor(CNRM_245_2081.grd))) +
  scale_fill_manual(name = "Range Change", values=c("gray88","#440154FF","#29AF7FFF","#FDE725FF","transparent"), labels = c("California Floristic Province","Loss","No Change","Gain",""), guide = guide_legend(reverse = TRUE)) +
  coord_sf() +
  xlab("Longitude") +
  ylab("Latitude") +
  theme_bw(base_size = 14)

binary_diff_CNRM2452081_gg

binary_diff_CNRM5852021_gg <- ggplot() +
  geom_raster(data = binary_diff_CNRM5852021_df, aes(x = x, y = y, fill = as.factor(CNRM_585_2021.grd))) +
  scale_fill_manual(name = "Range Change", values=c("gray88","#440154FF","#29AF7FFF","#FDE725FF","transparent"), labels = c("California Floristic Province","Loss","No Change","Gain",""), guide = guide_legend(reverse = TRUE)) +
  coord_sf() +
  xlab("Longitude") +
  ylab("Latitude") +
  theme_bw(base_size = 14)

binary_diff_CNRM5852021_gg

binary_diff_CNRM5852081_gg <- ggplot() +
  geom_raster(data = binary_diff_CNRM5852081_df, aes(x = x, y = y, fill = as.factor(CNRM_585_2081.grd))) +
  scale_fill_manual(name = "Range Change", values=c("gray88","#440154FF","#29AF7FFF","#FDE725FF","transparent"), labels = c("California Floristic Province","Loss","No Change","Gain",""), guide = guide_legend(reverse = TRUE)) +
  coord_sf() +
  xlab("Longitude") +
  ylab("Latitude") +
  theme_bw(base_size = 14)

binary_diff_CNRM5852081_gg
```


#10. Evaluate future projection layers to determine if there is any extrapolation that is occuring
```{r}
#generate dataframes
current <- as.data.frame(predictors.cfp)

#mess function
mess_BCC_245_2021 <- mess(x = BCC_245_2021_stack,
                          v = current,
                          full = FALSE,
                          filename = "data/output/MESS/BCC_245_2021.tif")

plot(mess_BCC_245_2021)
```


